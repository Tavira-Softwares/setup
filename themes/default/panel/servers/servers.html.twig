{% extends '@EasyAdmin/page/content.html.twig' %}

{% block title %}| {{ 'pteroca.servers.title'|trans }}{% endblock %}

{% block content_title %}{{ 'pteroca.servers.title'|trans }}{% endblock %}

{% block page_actions %}
    <div class="btn-group me-2" role="group" aria-label="Widok">
        <button type="button" class="btn btn-outline-primary active" id="view-cards" title="Widok kafelków">
            <i class="fas fa-th-large"></i>
        </button>
        <button type="button" class="btn btn-outline-primary" id="view-list" title="Widok listy">
            <i class="fas fa-list"></i>
        </button>
    </div>
    <a class="btn btn-secondary" href="{{ path('panel') }}">
        {{ 'pteroca.system.back'|trans }}
    </a>
{% endblock %}

{% block main %}
    <div class="container mt-4">
        {% if servers|length > 0 %}
            {# Widok kafelków #}
            <div id="cards-view">
                {% set row = 1 %}
                {% for server in servers %}
                    {% if row == 1 %}
                        <div class="row">
                    {% endif %}
                    <div class="col-12 col-lg-6 col-xl-4 mb-4">
                        {% include 'panel/servers/components/server.html.twig' %}
                    </div>
                    {% if row % 3 == 0 %}
                        </div>
                    {% endif %}
                    {% set row = row + 1 %}
                {% endfor %}
                {% if row % 3 != 1 %}
                    </div>
                {% endif %}
            </div>

            <div id="list-view" style="display: none;">
                <div class="table-responsive">
                    <table class="table datagrid text-center">
                        <thead>
                            <tr>
                                <th class="pb-2">{{ 'pteroca.servers.status'|trans }}</th>
                                <th class="pb-2">{{ 'pteroca.servers.name'|trans }}</th>
                                <th class="pb-2">{{ 'pteroca.servers.ip_address'|trans }}</th>
                                <th class="pb-2">{{ 'pteroca.servers.ram_memory'|trans }}</th>
                                <th class="pb-2">{{ 'pteroca.servers.disk'|trans }}</th>
                                <th class="pb-2">{{ 'pteroca.servers.cpu'|trans }}</th>
                                <th class="pb-2">{{ 'pteroca.servers.valid_until'|trans }}</th>
                                <th class="pb-2">{{ 'pteroca.servers.actions'|trans }}</th>
                            </tr>
                        </thead>
                        <tbody class="placeholder-glow placeholder-wave">
                            {% for server in servers %}
                                {% include 'panel/servers/components/server-list.html.twig' %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="row">
                <div class="col-md-12">
                    {% include 'panel/servers/components/alert.html.twig' %}
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block body_javascript %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const viewCardsBtn = document.getElementById('view-cards');
            const viewListBtn = document.getElementById('view-list');
            const cardsView = document.getElementById('cards-view');
            const listView = document.getElementById('list-view');

            const savedView = localStorage.getItem('servers-view') || 'cards';
            if (savedView === 'list') {
                switchToListView();
            }

            viewCardsBtn.addEventListener('click', function() {
                switchToCardsView();
                localStorage.setItem('servers-view', 'cards');
            });

            viewListBtn.addEventListener('click', function() {
                switchToListView();
                localStorage.setItem('servers-view', 'list');
            });

            function switchToCardsView() {
                viewCardsBtn.classList.add('active');
                viewListBtn.classList.remove('active');
                cardsView.style.display = 'block';
                listView.style.display = 'none';
            }

            function switchToListView() {
                viewListBtn.classList.add('active');
                viewCardsBtn.classList.remove('active');
                cardsView.style.display = 'none';
                listView.style.display = 'block';
            }

            const serverElements = document.querySelectorAll('[data-server-id]');

            serverElements.forEach(element => {
                const serverId = element.getAttribute('data-server-id'),
                    endpointUrl = '{{ path('panel') }}/api/server/' + serverId + '/details'

                fetch(endpointUrl)
                    .then(response => response.json())
                    .then(data => {
                        updateServerElements(element, data);
                        document.querySelectorAll('.placeholder-glow').forEach(el => el.classList.remove('placeholder-glow'));
                        document.querySelectorAll('.placeholder-wave').forEach(el => el.classList.remove('placeholder-wave'));
                    })
                    .catch(error => console.error('Error fetching server details:', error));
            });

            function updateServerElements(element, data, prefix = '') {
                for (const [key, value] of Object.entries(data)) {
                    let dataKey = prefix ? `${prefix}-${key}` : key;
                    dataKey = dataKey.replaceAll(' ', '-').replaceAll('.', '-').toLowerCase();
                    if (typeof value === 'object' && value !== null) {
                        updateServerElements(element, value, dataKey);
                    } else {
                        const targetElement = element.querySelector(`[data-${dataKey}]`);
                        if (targetElement) {
                            if (targetElement.hasAttribute('data-unit')) {
                                targetElement.textContent = `${value} ${targetElement.getAttribute('data-unit')}`;
                            } else {
                                targetElement.textContent = value;
                            }
                            targetElement.classList.remove('placeholder');
                        }
                    }
                }
            }
        });
    </script>
{% endblock %}
