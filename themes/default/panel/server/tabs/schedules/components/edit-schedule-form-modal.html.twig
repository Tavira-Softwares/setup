<!-- Modal edycji harmonogramu (formularz) -->
{% if hasServerPermission(serverData.serverPermissions, 'schedule.update') %}
<div class="modal fade" id="editScheduleFormModal" tabindex="-1" aria-labelledby="editScheduleFormModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editScheduleFormModalLabel">{{ 'pteroca.server.edit'|trans }} {{ 'pteroca.server.schedule_name'|trans|lower }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editScheduleFormForm" onsubmit="saveEditedSchedule(); return false;">
                <div class="modal-body">
                    <!-- Schedule name section -->
                    <div class="mb-4">
                        <label for="editScheduleName" class="form-label">{{ 'pteroca.server.schedule_name'|trans }}</label>
                        <input type="text" class="form-control" id="editScheduleName" name="name" required>
                        <div class="form-text">{{ 'pteroca.server.schedule_name_description'|trans }}</div>
                    </div>
                    
                    <!-- Cron expression section -->
                    <div class="mb-4">
                        <label class="form-label">{{ 'pteroca.server.schedule_cron_expression'|trans }}</label>
                        <div class="row">
                            <div class="col">
                                <label for="editCronMinute" class="form-label small">{{ 'pteroca.server.minute'|trans }}</label>
                                <input type="text" class="form-control" id="editCronMinute" name="minute" required>
                            </div>
                            <div class="col">
                                <label for="editCronHour" class="form-label small">{{ 'pteroca.server.hour'|trans }}</label>
                                <input type="text" class="form-control" id="editCronHour" name="hour" required>
                            </div>
                            <div class="col">
                                <label for="editCronDayOfMonth" class="form-label small">{{ 'pteroca.server.day_of_month'|trans }}</label>
                                <input type="text" class="form-control" id="editCronDayOfMonth" name="day_of_month" required>
                            </div>
                            <div class="col">
                                <label for="editCronMonth" class="form-label small">{{ 'pteroca.server.month'|trans }}</label>
                                <input type="text" class="form-control" id="editCronMonth" name="month" required>
                            </div>
                            <div class="col">
                                <label for="editCronDayOfWeek" class="form-label small">{{ 'pteroca.server.day_of_week'|trans }}</label>
                                <input type="text" class="form-control" id="editCronDayOfWeek" name="day_of_week" required>
                            </div>
                        </div>
                        <div class="form-text">{{ 'pteroca.server.cron_expression_description'|trans }}</div>
                    </div>
                    
                    <!-- Options section -->
                    <div class="mb-4">
                        <h6 class="mb-3">{{ 'pteroca.server.schedule_options'|trans }}</h6>
                        
                        <!-- Show cheatsheet toggle -->
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="editShowCheatsheet" name="show_cheatsheet">
                            <label class="form-check-label" for="editShowCheatsheet">
                                {{ 'pteroca.server.show_cheatsheet'|trans }}
                            </label>
                            <div class="form-text">{{ 'pteroca.server.show_cheatsheet_description'|trans }}</div>
                        </div>
                        
                        <!-- Only when server is online -->
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="editOnlyWhenOnline" name="only_when_online">
                            <label class="form-check-label" for="editOnlyWhenOnline">
                                {{ 'pteroca.server.only_when_server_online'|trans }}
                            </label>
                            <div class="form-text">{{ 'pteroca.server.only_when_server_online_description'|trans }}</div>
                        </div>
                        
                        <!-- Schedule enabled -->
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="editScheduleEnabled" name="is_active">
                            <label class="form-check-label" for="editScheduleEnabled">
                                {{ 'pteroca.server.schedule_enabled'|trans }}
                            </label>
                            <div class="form-text">{{ 'pteroca.server.schedule_enabled_description'|trans }}</div>
                        </div>
                    </div>
                    
                    <!-- Cron cheatsheet (hidden by default) -->
                    <div id="editCronCheatsheet" class="alert alert-info" style="display: none;">
                        <h6>{{ 'pteroca.server.cron_cheatsheet'|trans }}</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>{{ 'pteroca.server.examples'|trans }}:</strong><br>
                                <code>*/5 * * * *</code> - {{ 'pteroca.server.every_5_minutes'|trans }}<br>
                                <code>0 */2 * * *</code> - {{ 'pteroca.server.every_2_hours'|trans }}<br>
                                <code>0 0 * * 0</code> - {{ 'pteroca.server.every_sunday'|trans }}<br>
                            </div>
                            <div class="col-md-6">
                                <strong>{{ 'pteroca.server.special_values'|trans }}:</strong><br>
                                <code>*</code> - {{ 'pteroca.server.any_value'|trans }}<br>
                                <code>*/n</code> - {{ 'pteroca.server.every_n_units'|trans }}<br>
                                <code>n-m</code> - {{ 'pteroca.server.range_n_to_m'|trans }}<br>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'pteroca.server.cancel'|trans }}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> {{ 'pteroca.server.save'|trans }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Hidden input do przechowywania ID edytowanego harmonogramu -->
<input type="hidden" id="editingScheduleId" value="">

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle cron cheatsheet for edit modal
    document.getElementById('editShowCheatsheet').addEventListener('change', function() {
        const cheatsheet = document.getElementById('editCronCheatsheet');
        if (this.checked) {
            cheatsheet.style.display = 'block';
        } else {
            cheatsheet.style.display = 'none';
        }
    });
});

function openEditScheduleForm(scheduleId) {
    // Pobierz dane harmonogramu
    fetch('{{ path('server_schedules_get', { id: server.id, scheduleId: '__SCHEDULE_ID__' }) }}'.replace('__SCHEDULE_ID__', scheduleId), {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('{{ 'pteroca.server.error'|trans }}: ' + data.error);
            return;
        }
        
        // Wypełnij formularz danymi
        document.getElementById('editingScheduleId').value = scheduleId;
        document.getElementById('editScheduleName').value = data.name || '';
        document.getElementById('editCronMinute').value = data.cron?.minute || '*';
        document.getElementById('editCronHour').value = data.cron?.hour || '*';
        document.getElementById('editCronDayOfMonth').value = data.cron?.day_of_month || '*';
        document.getElementById('editCronMonth').value = data.cron?.month || '*';
        document.getElementById('editCronDayOfWeek').value = data.cron?.day_of_week || '*';
        document.getElementById('editOnlyWhenOnline').checked = data.only_when_online || false;
        document.getElementById('editScheduleEnabled').checked = data.is_active || false;
        
        // Otwórz modal
        const modal = new bootstrap.Modal(document.getElementById('editScheduleFormModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{{ 'pteroca.server.error_occurred'|trans }}');
    });
}

function saveEditedSchedule() {
    const form = document.getElementById('editScheduleFormForm');
    const formData = new FormData(form);
    const scheduleId = document.getElementById('editingScheduleId').value;
    
    const name = formData.get('name');
    const minute = formData.get('minute');
    const hour = formData.get('hour');
    const dayOfMonth = formData.get('day_of_month');
    const month = formData.get('month');
    const dayOfWeek = formData.get('day_of_week');
    const isActive = formData.get('is_active') === 'on';
    const onlyWhenOnline = formData.get('only_when_online') === 'on';
    
    if (!name) {
        alert('{{ 'pteroca.server.schedule_name'|trans }} {{ 'pteroca.server.email_required'|trans|lower }}');
        return;
    }
    
    if (!minute || !hour || !dayOfMonth || !month || !dayOfWeek) {
        alert('{{ 'pteroca.server.cron_expression_description'|trans }}');
        return;
    }
    
    fetch('{{ path('server_schedules_update', { id: server.id, scheduleId: '__SCHEDULE_ID__' }) }}'.replace('__SCHEDULE_ID__', scheduleId), {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            name: name,
            minute: minute,
            hour: hour,
            day_of_month: dayOfMonth,
            month: month,
            day_of_week: dayOfWeek,
            is_active: isActive,
            only_when_online: onlyWhenOnline
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('{{ 'pteroca.server.error'|trans }}: ' + data.error);
        } else {
            alert('{{ 'pteroca.server.data_updated_successfully'|trans }}');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{{ 'pteroca.server.error_occurred'|trans }}');
    });
    
    // Zamknij modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('editScheduleFormModal'));
    modal.hide();
}
</script>
{% endif %}
